<!doctype html>
<html lang="en">
  <head>
    <title>CSCI 3308 Lab 7</title>
    <!-- Bootstrap core CSS & JS -->
	<link rel="stylesheet" type="text/css" href="../resources/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../resources/css/prism.css">

	<script src="../resources/js/jquery-3.3.1.js"></script>
	<script src="../resources/js/popper.js" ></script>
	<script src="../resources/js/bootstrap.js"></script>
	<script src="../resources/js/clipboard.js"></script>
	<script src="../resources/js/prism.js"></script>
	<!-- Custom CSS -->
	<link rel="stylesheet" type="text/css" href="../resources/css/labLayout.css">
	<script src="../resources/js/labScripts.js"></script>
	</head>
    <body onload="loadPage()">
		<main role="main" class="container">
			<div class="container-fluid">
			  <div class="row">
				<div class="col-10">
					<h1 class="display-4">Lab 7 Node.JS</h1>
					<p class="lead">
							In this lab, we will integrate all of the components that we have learned in this course so far. We will create a backend server and connect it to our database. We will also connect our backend server to our front-end or client-side webpages. You will edit the extended template (below) which includes all of the files necessary to work with Node.
							To receive credit for this lab, you MUST complete steps 1 and 2 in recitation and get marked off by your TA. You MUST complete step 3 and 4 (either in recitation or on your own) and upload "lab_7_link.txt" to Canvas by the deadline.
						 <b style="color: #27C47C;">It is highly recommended that you work with a partner on this lab -- it's a long one. </b> Make sure to include your partners name at the top of "lab_7_link.txt". <br></p>
             <dd>
               <div class="alert alert-primary" role="alert">
                 <u>NOTE:</u> This lab is due two weeks from now, right before recitation.
               </div>
             </dd>
					<p class="h5"><a href="./Lab_Website_3.zip">Download </a>the extended template and make sure you extract the files before using them.</p>
          <p> Useful link to help with this lab : </p>
          <ul>
            <li> Pug ( previously also known as Jade): <a href="https://pugjs.org/api/getting-started.html" target=_blank>pugjs documentation</a> </li>
				</div>
				<div class="col-2">
					<table class="table">
						<tr>
							<th class="h5" style="text-align:center">Est. Time  &#x023F1;</th>
						</tr>
						<tr>
							<td class="h5" style="text-align:center"><span id="eta">120</span> minutes</td>
						</tr>
					</table>
				</div>
			  </div>
			</div>


			<div class="card card-body" id="step1">
				<div class="stepLine">
					<p class="alignleft h5">1. Update PostgreSQL Database</p>
					<button class="btn btn-primary btn-sm alignbtn" type="button" onclick="updateProgressBar(1)" >Mark Complete</button>
					<button class="btn btn-primary btn-sm alignbtn" type="button" data-toggle="collapse" data-target="#multiCollapseExample1" aria-expanded="false" aria-controls="multiCollapseExample1">Expand</button>
					<p class="alignright h5">(<span class="time" id="time1">10</span> Minutes)</p>
				</div>
				<div class="collapse" id="multiCollapseExample1">
					<br>
					<p>We have to make a few updates to our PostgreSQL database.  We'll need to add a password to our database, update the football_players table to include image urls, and add a new table "favorite_colors".</p>
					<dl>
						<dt>Switch to the postgres user account</dt>
						<dd>
							During the installation process PostgreSQL created a new user account named postgres.  You'll be using this user account for most of your database interactions.
							<pre class="command-line" data-user="csci3308" data-host="csci3308-VirtualBox"><code  class="language-bash"> sudo -u postgres psql</code></pre>
						</dd>
						<dt>Create a password</dt>
						<dd>
							The node.js server will later on be setup to directly access our postgres database.  But in order to do that, our database has to have a password for our database connection tools.  Make sure you enter a password that you can remember!
							<pre class="command-line" data-prompt="postgres=#"><code  class="language-bash"> \password </code></pre>
						</dd>
						<dt>Switch to the football_db database</dt>
						<dd>
							<pre class="command-line" data-prompt="postgres=#"><code  class="language-bash"> \c football_db;</code></pre>
						</dd>
            <dt>Check the views in the database and drop them</dt>
						<dd>
              If you do not drop the views first you will not be allowed to drop the tables.
							<pre class="command-line" data-prompt="postgres=#"><code  class="language-bash">\dv;
DROP VIEW "view name you want to drop";</code></pre>
               </code></pre>
						</dd>
						<dt>Update our tables</dt>
						<dd>Copy the following code into psql terminal to create the football_player, footbal_games, and favorite_colors tables and populate them with data.  If you are having problems with your PostgreSQL installation, MAKE SURE TO DO THIS LAB WITH A PARTNER
							<pre class="command-line" data-prompt="football_db=#"><code  class="language-bash">DROP TABLE football_games;
CREATE TABLE IF NOT EXISTS football_games (
  visitor_name VARCHAR(30),       /* Name of the visiting team                     */
  home_score SMALLINT NOT NULL,   /* Final score of the game for the Buffs         */
  visitor_score SMALLINT NOT NULL,/* Final score of the game for the visiting team */
  game_date DATE NOT NULL,        /* Date of the game                              */
  players INT[] NOT NULL,         /* This array consists of the football player ids (basically a foreign key to the football_player.id) */
  PRIMARY KEY(visitor_name, game_date) /* A game's unique primary key consists of the visitor_name & the game date (this assumes you can't have multiple games against the same team in a single day) */
);

DROP TABLE football_players;
CREATE TABLE IF NOT EXISTS football_players(
  id SERIAL PRIMARY KEY,       /* Unique identifier for each player (it's possible multiple players have the same name/similiar information) */
  name VARCHAR(50) NOT NULL,   /* The player's first & last name */
  year VARCHAR(3),             /* FSH - Freshman, SPH - Sophomore, JNR - Junior, SNR - Senior */
  major VARCHAR(4),            /* The unique 4 character code used by CU Boulder to identify student majors (ex. CSCI, ATLS) */
  passing_yards SMALLINT,      /* The number of passing yards in the players entire football career  */
  rushing_yards SMALLINT,      /* The number of rushing yards in the players entire football career  */
  receiving_yards SMALLINT,    /* The number of receiving yards in the players entire football career*/
  img_src VARCHAR(200)         /* This is a file path (absolute or relative), that locates the player's profile image */
);

INSERT INTO football_games(visitor_name, home_score, visitor_score, game_date, players)
VALUES('Colorado State', 45, 13, '20180831', ARRAY [1,2,3,4,5]),
('Nebraska', 33, 28, '20180908', ARRAY [2,3,4,5,6]),
('New Hampshire', 45, 14, '20180915', ARRAY [3,4,5,6,7]),
('UCLA', 38, 16, '20180928', ARRAY [4,5,6,7,8]),
('Arizona State', 28, 21, '20181006', ARRAY [5,6,7,8,9]),
('Southern California', 20, 31, '20181013', ARRAY [6,7,8,9,10]),
('Washington', 13, 27, '20181020', ARRAY [7,8,9,10,1]),
('Oregon State', 34, 41, '20181027', ARRAY [8,9,10,1,2]),
('Arizona', 34, 42, '20181102', ARRAY [9,10,1,2,3]),
('Washington State', 7, 31, '20181110', ARRAY [10,1,2,3,4]),
('Utah', 7, 30, '20181117', ARRAY [1,2,3,4,5]),
('California', 21, 33, '20181124', ARRAY [2,3,4,5,6])
;

INSERT INTO football_players(name, year, major, passing_yards, rushing_yards, receiving_yards, img_src)
VALUES('Cedric Vega', 'FSH', 'ARTS', 15, 25, 33, '../resources/img/player1.jpg'),
('Myron Walters', 'SPH', 'CSCI', 32, 43, 52, '../resources/img/player2.jpg'),
('Javier Washington', 'JNR', 'MATH', 1, 61, 45, '../resources/img/player3.jpg'),
('Wade Farmer', 'SNR', 'ARTS', 14, 55, 12, '../resources/img/player4.jpg'),
('Doyle Huff', 'FSH', 'CSCI', 23, 44, 92, '../resources/img/player5.jpg'),
('Melba Pope', 'SPH', 'MATH', 13, 22, 45, '../resources/img/player6.jpg'),
('Erick Graves', 'JNR', 'ARTS', 45, 78, 98, '../resources/img/player7.jpg' ),
('Charles Porter', 'SNR', 'CSCI', 92, 102, 125, '../resources/img/player8.jpg'),
('Rafael Boreous', 'JNR', 'MATH', 102, 111, 105, '../resources/img/player9.jpg'),
('Jared Castillo', 'SNR', 'ARTS', 112, 113, 114, '../resources/img/player10.jpg');

DROP TABLE favorite_colors;
CREATE TABLE IF NOT EXISTS favorite_colors(
  hex_value VARCHAR(6) PRIMARY KEY, /* This is the hexvalue for the color, it assumes that the value DOES NOT # */
  name VARCHAR(50),                 /* The html safe name for the color.  This can be null */
  color_msg  TEXT NOT NULL          /* A message describing the chosen color */
);

INSERT INTO favorite_colors(hex_value, name, color_msg)
VALUES('FF6347', 'TOMATO', 'This color gets it name from the red fruit that at one time was considered poisonous!'),
('3CB371', 'Medium Sea Green', 'Not sure what the difference is between Small & Large Sea Green... but I guess this one is in between them.'),
('EE82EE','Violet', 'Roses are Red, Violets are blue...'),
('545AA7','Liberty', 'Not to be confused with the color of the Liberty Bell (which is indeed a copper color)');

INSERT INTO favorite_colors(hex_value, color_msg)
VALUES('FF2727', 'An unnamed red color'),
('27FF27', 'An unnamed green color'),
('870087', 'An unnamed magenta color'),
('8F8FFF', 'An unnamed blue color');</code></pre>
						</dd>
						<dt>Exit the psql terminal</dt>
						<dd>
							<pre class="command-line" data-prompt="postgres=#"><code  class="language-bash"> \q</code></pre>
						</dd>
						<dt>Ensure our postgres service is running in the background</dt>
						<dd>
							<pre class="command-line" data-user="csci3308" data-host="csci3308-VirtualBox"><code  class="language-bash">sudo -u postgres service postgresql start</code></pre>
						</dd>
					</dl>
				</div>
			</div>

			<div class="card card-body" id="step2">
				<div class="stepLine">
					<p class="alignleft h5">2. Home Page</p>
					<button class="btn btn-primary btn-sm alignbtn" type="button" onclick="updateProgressBar(2)" >Mark Complete</button>
					<button class="btn btn-primary btn-sm alignbtn" type="button" data-toggle="collapse" data-target="#multiCollapseExample2" aria-expanded="false" aria-controls="multiCollapseExample2">Expand</button>
					<p class="alignright h5">(<span class="time" id="time2">40</span> Minutes)</p>
				</div>
				<div class="collapse" id="multiCollapseExample2">
					<p>First, we will implement our home page.  This will include handling a GET request, POST request, and accessing our postgres database that we updated in the previous step.</p>
          <dl>
						<dt>1. Handling a Get Request</dt>
						<dd>
							<p>Let's start by adding a way for us to access our home page, via a GET request.  Copy the following code into your server.js file (right after the login & registration pages' app.get())</p>
							<pre><code class="language-js">app.get('/home', function(req, res) {
	res.render('pages/home',{
		my_title:'Home Page',
		color: 'FF0000',
		color_msg: 'The Color Red'
	});
});</code></pre>

							<a class="btn btn-warning dropdown-toggle" id="hidetext1" href="#explanation1" onclick="showExplanation(1)">More information</a>
								<br>
								<div id = "explanation1" style="display:none;">
										<dl class="row">
												<dt class="col-sm-3">app.get</dt>
												<dd class="col-sm-9">Here we define which method we want to work with (our only options are get/post).  For a lot of our webpage routing, we'll be using get requests.</dd>
												<dt class="col-sm-3">'/home'</dt>
												<dd class="col-sm-9">Our server will be listening for this specific route to be added to our website's base url.  <b style="color:red">THIS IS NOT A RELATIVE PATH!</b>  This is a route, that our server is listening to and then works on then decides on how best to render the home page</dd>
												<dt class="col-sm-3">res.render('pages/home'</dt>
												<dd class="col-sm-9">The res object will allow us to render our webpage.  Here we are defining the route to our home webpage's .html file (file extension not included), based on our starting point being the views directory. <b style="color:red">THIS IS WHERE YOU USE A RELATIVE PATH!</b></dd>
												<dt class="col-sm-3">my_title:'Home Page'</dt>
												<dd class="col-sm-9">After our path, inside of a pair of curly braces, we can define any variables we wish to pass onto our webpage. These variables (a.k.a. parameters) can then be referenced inside of the view or html file and dynamically decide what information is shown to the user.  In this case, we are passing in the title of our web page.</dd>
												<dt class="col-sm-3">color:'FF0000'</dt>
												<dd class="col-sm-9">This variable defines the color we will be using to update our webpage's background color.  For now, let's hard-coded our value to be the hex value for red.  Later on, we'll incorporate a get request parameter & a database query.</dd>
												<dt class="col-sm-3">color_msg:'The Color Red'</dt>
												<dd class="col-sm-9">This variable defines a message that describes our color.  For now, let's keep it hard-coded with 'The Color Red'</dd>
											</dl>
								</div>

							<br>
							<p><b>Start our Webserver</b></p>
							<p>To load our home page, we will need to first start up our Node.js server.  Copy the following command into your terminal (make sure you are in the same directory as your server.js file!)</p>
							<pre class="command-line" data-user="csci3308" data-filter-output="(out)" data-host="csci3308-VirtualBox"><code  class="language-bash">node server.js
(out)3000 is the magic port</code></pre>
							<br>
							<p><b>View our Webpage</b></p>
							<p>To view our homepage, go to <a href="localhost:3000/home">localhost:3000/home</a>.  For this lab, our server will only be accessible locally, so we will use localhost for our ip-address.  We will follow this with our port number (3000) and the route we are taking "/home". Now, you will notice our background-color hasn't changed, nor is our message ('The Color Red') displayed.  We will need to update our home.pug file to make use of the parameters from our HTTP request.</p>
						</dd>
            <dd>
              <div class="alert alert-danger" role="alert">
                <u>SUGGESTION:</u> It is very important to manage the whitespace when using pug!
              </div>
            </dd>
						<hr>
						<br>
						<dt>2. Update Home.pug</dt>
						<dd>
							<p>Open up the home.pug file (inside views/pages) and you will find a commented line called TODO: FIRST PUG UPDATE.  Add the following code, which will now use our new parameters!</p>
							<pre><code class="language-html">- if(color)
	p= color_msg
	body(style="background-color: #"+color)</code></pre>

							<a class="btn btn-warning dropdown-toggle" id="hidetext2" href="#explanation2" onclick="showExplanation(2)">More information</a>
							<br>
							<div id = "explanation2" style="display:none;">
									<dl class="row">
											<dt class="col-sm-3">if(color) </dt>
											<dd class="col-sm-9">color is a parameter sent by our server. When working with parameters that are passed into our view, there is not guarantee that the variable will be set.  Sometimes our parameters will be null which might signify that a portion of our webpage shouldn't be shown.  Currently, color is hard coded to the value 'FF0000', but that won't stay the case for long! </dd>
											<dt class="col-sm-3">p= color_msg</dt>
											<dd class="col-sm-9">p= is pug syntax for assigning a value to the innerHTML. In this case, we are assigning the value of color_msg to a paragraph element and then adding this element to the DOM to be displayed on our page.</dd>
										</dl>
							</div>

							<br>
							<p><b>Refresh Home Page</b></p>
							<p>After you have updated the .pug file, you can simply refresh your browser to view the changes.  You only have to restart your server when you make changes to the server.js file</p>
						</dd>
						<hr>
						<br>
						<dt>3. Handle a Database Request</dt>
						<dd>
							Now we will work on handling a simple database request.  Our goal here is to have our home page list a button for each color option in our favorite_colors table.  Let's start by <b style="color:red">replacing</b> our previous get request in our server.js file with the following code:
							<pre><code class="language-js">app.get('/home', function(req, res) {
	var query = 'select * from favorite_colors;';
	db.any(query)
        .then(function (rows) {
            res.render('pages/home',{
				my_title: "Home Page",
				data: rows,
				color: '',
				color_msg: ''
			})

        })
        .catch(function (err) {
            // display error message in case an error
            request.flash('error', err);
            response.render('pages/home', {
                title: 'Home Page',
                data: '',
                color: '',
                color_msg: ''
            })
        })
});</code></pre>

						<a class="btn btn-warning dropdown-toggle" id="hidetext3" href="#explanation3" onclick="showExplanation(3)">More information</a>
						<br>
						<div id = "explanation3" style="display:none;">
								<dl class="row">
										<dt class="col-sm-3">var query = ...</dt>
										<dd class="col-sm-9">Here we set the postgres query we want to execute.  Make sure you place a semi-colon INSIDE the single quotes, to ensure the query is able to run.  Without it, you will receive some server errors!</dd>
										<dt class="col-sm-3">db.any(query)</dt>
										<dd class="col-sm-9">Using the database object created earlier in our server.js file, we can pass in our query to our postgres database.  We are using the "any" function which means our query will return zero or more rows.  Check out some of the additional documentation here: <a href="https://vitaly-t.github.io/pg-promise/Database.html#any">Documentation</a></dd>
										<dt class="col-sm-3">.then & .catch</dt>
										<dd class="col-sm-9">The then/catch components operate like a try/catch block in other programming languages.  Inside of the .then() we'll execute our code IF our query is successful (no errors), otherwise we will jump over to the .catch()</dd>
										<dt class="col-sm-3">function (rows) {</dt>
										<dd class="col-sm-9">Inside of our .then() we will create a function that will hold onto the results from our postgres query.  For this example, we have named the data "rows" but you can name it just about any variable name you wish.</dd>
										<dt class="col-sm-3">data: rows,</dt>
										<dd class="col-sm-9">Inside of render call we will update our parameters.  We now have a new parameter called data, which will hold the query results. We've also removed our hard-coded values and instead just use '' for color * color_msg.</dd>
									</dl>
						</div>

						</dd>
            <dd>
              <div class="alert alert-success" role="alert">
                Do not forget to change the postgres password in server.js file. It is set to 'pwd' now, change it to the password you set at the beginning.
              </div>
            </dd>

						<hr>
						<br>
						<dt>4. Iterate over Query Results in home.pug</dt>
						<dd>
							<p>Now that we have access to our favorite_colors' data, we can update our home page to include some buttons and a form to update our webpage's background-color.  Add the following code below the TODO: Second Pug Update, which is listed inside of the home.pug file. </p>
							<pre><code class="language-html">- if(data)
	for item in data
		if(item.name)
			button.btn.btn-block(type="submit", name="color_selection", value= item.hex_value, style="background-color: #" + item.hex_value)= item.name
		else
			button.btn.btn-block(type="submit", name="color_selection", value= item.hex_value, style="background-color: #" + item.hex_value)= item.hex_value</code></pre>

						<a class="btn btn-warning dropdown-toggle" id="hidetext4" href="#explanation4" onclick="showExplanation(4)">More information</a>
						<br>
						<div id = "explanation4" style="display:none;">
								<dl class="row">
										<dt class="col-sm-3">for item in data</dt>
										<dd class="col-sm-9">The easiest way to step through each row, is with a foreach statement.  If you want to see how the data is structured, try adding a console.log(data)!</dd>
										<dt class="col-sm-3">if(item.name){ </dt>
										<dd class="col-sm-9">We have used if statements to check if our parameters (data, color, color_msg) are set, but we can also use them to see if our database fields are set (i.e. null or not null).  In this case, the name field can be null.  If this occurs for one of the rows we retrieve, our code will display the hex value inside of our button, instead of name.</dd>
										<dd class="col-sm-3">button.btn.btn-block(...)= item.name</dd>
										<dd class="col-sm-9">Here, we are creating a button with some different classes and attributes and setting the innerHTML to the item.name</dd>
									</dl>
						</div>
						<br>
            <p><b>Restart The Server</b></p>
            <div class="row">
  						<div class="col-6">
                <p>Now that our home.pug file and server.js files have been updated, go ahead and restart the Node.js server.  Remember you can use ctrl + c to end a running application in Linux.  Then you can re-run "node server.js", to restart our server.  Refresh your webpage and you should now see a series of buttons displayed. </p>
                                </div>
                <div class="col-6"  style="text-align:center;">
                  <img class="img-fluid" src="img/home.png" alt="Screenshot of the login page" style="height:400px;">
  						</div>
  					</div>

						<hr>
						<br>
						<dt>5. Process a GET Request's Parameters</dt>
						<dd>
							<p>Our home page has a form which contains all of our potential color options. But it still cannot change our background color! We need to add a new route to our server.js file which can accept and process our GET request's color_selection parameter. Add the following code, below our previous app.get(/home). <b style="color:red">ADD THIS CODE, this will NOT replace our existing get.app('\home').</b></p>
							<pre><code class="language-js">app.get('/home/pick_color', function(req, res) {
	var color_choice = req.query.color_selection;
	var color_options =  'select * from favorite_colors;';
	var color_message = "select color_msg from favorite_colors where hex_value = '" + color_choice + "';";
	db.task('get-everything', task => {
        return task.batch([
            task.any(color_options),
            task.any(color_message)
        ]);
    })
    .then(info => {
    	res.render('pages/home',{
				my_title: "Home Page",
				data: info[0],
				color: color_choice,
				color_msg: info[1][0].color_msg
			})
    })
    .catch(error => {
        // display error message in case an error
            req.flash('error', error);//if this doesn't work for you replace with console.log
            res.render('pages/home', {
                title: 'Home Page',
                data: '',
                color: '',
                color_msg: ''
            })
    });

});</code></pre>

						<a class="btn btn-warning dropdown-toggle" id="hidetext5" href="#explanation5" onclick="showExplanation(5)">More information</a>
						<br>
						<div id = "explanation5" style="display:none;">
								<dl class="row">
										<dt class="col-sm-5">'/home/pick_color'</dt>
										<dd class="col-sm-7">This route has to match the action="" field from our form!  This is how the server nows to handle our form's get request.</dd>
										<dt class="col-sm-5">req.query.color_selection</dt>
										<dd class="col-sm-7">To access our the parameters of our get request, we will use "req.query", which is followed by the name of the parameter we wish to access.  The color_selection parameter matches the name field from the buttons we created on our home page: &lt;button name="color_selection></dd>
										<dt class="col-sm-5">var color_message = ...</dt>
										<dd class="col-sm-7">Our color_message is a second query which explicit grabs the color_msg for our chosen color.</dd>
										<dt class="col-sm-5">db.task('get-everything', task => {</dt>
										<dd class="col-sm-7">We now have multiple queries to deal with!  To handle them all, we will use the database's task operation which can handle batch processing of our queries.</dd>
										<dt class="col-sm-5">task.any(color_options),</dt>
										<dd class="col-sm-7">Inside of db.task() we can list as many queries as we need.  Just make sure to separate the queries with commas!</dd>
										<dt class="col-sm-5">data: info[0],</dt>
										<dd class="col-sm-7">When working with multiple queries, we will have to operate with multiple results.  The variable info is an array with all of our results.  To access an individual query's results we use info[query_index]. </dd>
										<dt class="col-sm-5">color_msg: info[1][0].color_msg</dt>
										<dd class="col-sm-7">Since our second query only has 1 value returned, we can actually access it's field directly (color_msg). </dd>
									</dl>
						</div>

						</dd>
						<hr>
						<br>
						<dt>6. Add POST Request Form</dt>
						<dd>
							<p>Our final task for our home page is to include a form that lets us add a new favorite color, via a POST request. Copy and paste the following code below TODO: Third Update, within the form tags for our POST request!</p>
							<pre><code class="language-html">div.form-group.row
	label.col-sm-2.col-form-label(for="color_hex") Color Hex Value:
	div.col-sm-10
		input.form-control#color_hex(type="text", name="color_hex", placeholder="Enter Hex Value", maxlength="6")
div.form-group.row
	label.col-sm-2.col-form-label(for="color_name") Color Name:
	div.col-sm-10
		input.form-control#color_name(type="text", name="color_name", placeholder="Enter Color's Name")
div.form-group.row
	label.col-sm-2.col-form-label(for="color_message") Color Message:
	div.col-sm-10
		input.form-control#color_message(type="text", name="color_message", placeholder="Enter the Color's Description")
button.btn.btn-primary.btn-block(type="submit") Submit </code></pre>
						</dd>
						<hr>
						<br>
						<dt>7. Handle the POST Request's Parameters</dt>
						<dd>
							<p>The following code is the last update we need to make to our server.js (with respects to our home page).  We'll be adding an app.post(). It will use the same route as our get request ('/home/pick_color') but processes the form data using a POST request and applies an insert to our favorite_colors table.</p>
							<pre><code class="language-js">app.post('/home/pick_color', function(req, res) {
	var color_hex = req.body.color_hex;
	var color_name = req.body.color_name;
	var color_message = req.body.color_message;
	var insert_statement = "INSERT INTO favorite_colors(hex_value, name, color_msg) VALUES('" + color_hex + "','" +
							color_name + "','" + color_message +"') ON CONFLICT DO NOTHING;";

	var color_select = 'select * from favorite_colors;';
	db.task('get-everything', task => {
        return task.batch([
            task.any(insert_statement),
            task.any(color_select)
        ]);
    })
    .then(info => {
    	res.render('pages/home',{
				my_title: "Home Page",
				data: info[1],
				color: color_hex,
				color_msg: color_message
			})
    })
    .catch(error => {
        // display error message in case an error
            req.flash('error', error); //if this doesn't work for you replace with console.log
            res.render('pages/home', {
                title: 'Home Page',
                data: '',
                color: '',
                color_msg: ''
            })
    });
});</code></pre>

						<a class="btn btn-warning dropdown-toggle" id="hidetext6" href="#explanation6" onclick="showExplanation(6)">More information</a>
						<br>
						<div id = "explanation6" style="display:none;">
								<dl class="row">
										<dt class="col-sm-5">app.post()</dt>
										<dd class="col-sm-7">We are not working with a post request.  Much of the syntax here is similiar to the get request, but the key difference will be in how we access our post data vs get data.</dd>
										<dt class="col-sm-5">req.body.color_hex</dt>
										<dd class="col-sm-7">To access our post data we will need to use our "body-parser" module.  This changes our notation from "req.query"(get) to "req.body"(post).  With each being followed by the parameter name we want to work with.</dd>
										<dt class="col-sm-5">var insert_statement = ...</dt>
										<dd class="col-sm-7">Handling an insert statement is just about the same as our select statements.  We set a variable with the insert statement's information and then pass it to our db.task() method.  We are using db.task here because we need to add a new value AND retrieve our new list of colors.</dd>
										<dt class="col-sm-5">data: info[1],</dt>
										<dd class="col-sm-7">Because our select statement is our second query, it will be at index 1 in our info array which contains all of our query results.</dd>
										<dt class="col-sm-5">color: color_hex</dt>
										<dd class="col-sm-7">After running our two queries, we will pass in our brand new color and use it to set our home page's background-color.</dd>
									</dl>
						</div>

						</dd>
						<hr>
						<br>
						<dt> More information: GET vs. POST</dt>
						<dd>
						<p><b>GET Request</b></p>
							A get request will pass information to the server via the URL by appending parameters & values to the end of the URL address.  This information can then be parsed and processed by the server.  <b>Key Benefit: A get request is visible to the user and can therefore be bookmarked, saved, and shared by the user</b>
							<p>Basic Get Form</p>
							<pre><code class="language-html">form(action="route/to/take", method="get")
	input(type="text", placeholder="Text here", name="parameter_name")
	button(type="submit") Submit </code></pre>
							<p>Displayed as:
								<input type="text" placeholder="Text here" name="parameter_name">
								<button type="submit">Submit</button></p>
							<br>
							<p><b>Handling A GET Request</b></p>
							<pre><code class="language-js">app.get('/route/to/take', function(req, res) {
	var get_variable = req.query.parameter_name;
	res.render('pages/web_page_name',{
		text_variable:"Text Value",
		number_variable: 5,
		parameter_variable: get_variable
	});
});</code></pre>

							<a class="btn btn-warning dropdown-toggle" id="hidetext7" href="#explanation7" onclick="showExplanation(7)">More information</a>
							<br>
							<div id = "explanation7" style="display:none;">
									<dl class="row">
											<dt class="col-sm-3">app.get</dt>
											<dd class="col-sm-9">Here we define which method we want to work with (our only options are get/post).  For a lot of our webpage routing, we'll be using get requests.</dd>
											<dt class="col-sm-3">'/route/to/take'</dt>
											<dd class="col-sm-9">Our server will be listening for this specific route to be added to our website's base url.  <b style="color:red">THIS IS NOT A RELATIVE PATH!</b>  Our server will be working with routes now and it will then determine which webpage to load and how.  This means we can have multiple routes which all lead to the same webpage (each one potentially loading the page differently).  Also, since this is not a relative path to our webpage, a route's information may not explicitly state which webpage it is referencing.</dd>
											<dt class="col-sm-3">req.query.parameter_name</dt>
											<dd class="col-sm-9">To retrieve the parameter values from our quest request we need to use 'req.query' followed by the name of the parameter we want to access.  This will let use grab in any values passed to use via a form's get submission.</dd>
											<dt class="col-sm-3">res.render('pages/web_page'</dt>
											<dd class="col-sm-9">The res object will allow us to render our webpage.  Here we are defining the route to our webpage, based on our starting point being the views directory. <b style="color:red">THIS IS WHERE YOU USE A RELATIVE PATH!</b></dd>
											<dt class="col-sm-3">variable_name:"Text Value",</dt>
											<dd class="col-sm-9">After our path, inside of a pair of curly braces, we can define any variables we wish to pass onto our webpage. These variables can then be referenced inside of the view or ejs file and dynamically decide what information is shown on to the user.</dd>
										</dl>
							</div>
						<br>
						<p><b>POST Request</b></p>
							A post request will pass information to the server via a data package, which is hidden from the user.  But be aware, this does not hide the information from anyone "sniffing" the network.  You will have to use other tools (such as SSL) to properly secure the post request.  <b>Key Benefit: Information is hidden from the user (& with SSL it can be secured), which makes this a great option for login information & handling form data like account registration.</b>
							<p>Basic Post Form</p>
							<pre><code class="language-html">!-- The only difference here is method has changed to post! -->
form(action="route/to/take", method="post")
	input(type="text", placeholder="Text here", name="parameter_name")
	button(type="submit") Submit </code></pre>
							<p>Displayed as:
								<input type="text" placeholder="Text here" name="parameter_name">
								<button type="submit">Submit</button></p>
							<br>
							<p><b>Handling A POST Request</b></p>
							<pre><code class="language-js">app.post('/route/to/take', function(req, res) {
	var get_variable = req.body.parameter_name;
	res.render('pages/web_page_name',{
		text_variable:"Text Value",
		number_variable: 5,
		parameter_variable: get_variable
	});
});</code></pre>


							<a class="btn btn-warning dropdown-toggle" id="hidetext8" href="#explanation8" onclick="showExplanation(8)">More information</a>
							<br>
							<div id = "explanation8" style="display:none;">
									<dl class="row">
											<dt class="col-sm-3">app.post</dt>
											<dd class="col-sm-9">Most of the information for our post request is identical to our get request.  The only two differences are here in the method call to post & in accessing our passed in parameters.</dd>
											<dt class="col-sm-3">req.body.parameter_name;</dt>
											<dd class="col-sm-9">To retrieve the parameter values from our quest request we need to use 'req.body' followed by the name of the parameter we want to access.  This will be utilizing an npm module called "body-parser" which parses the post requests data for us.</dd>
										</dl>
							</div>
						</dd>
					</dl>
				</div>
			</div>




		<div class="card card-body" id="step3">
			<div class="stepLine">
					<p class="alignleft h5">3. Team Stats Page</p>
					<button class="btn btn-primary btn-sm alignbtn" type="button" onclick="updateProgressBar(3)" >Mark Complete</button>
					<button class="btn btn-primary btn-sm alignbtn" type="button" data-toggle="collapse" data-target="#multiCollapseExample3" aria-expanded="false" aria-controls="multiCollapseExample3">Expand</button>
					<p class="alignright h5">(<span class="time" id="time3">30</span> Minutes)</p>
				</div>
				<div class="collapse" id="multiCollapseExample3">
					<dl>
						<dt><br>TODO: Edit your sever.js and team_stats.pug files to populate the two tables.</dt>
						<dd><br>
							<pre>
Team Stats Page:
/team_stats - get request (no parameters)
	This route will require no parameters.  It will require 3 postgres queries which will:
		1. Retrieve all of the football games in the Fall 2018 Season
		2. Count the number of winning games in the Fall 2018 Season
		3. Count the number of lossing games in the Fall 2018 Season
	The three query results will then be passed on to the team_stats view (pages/team_stats).
	The team_stats view will display all fo the football games for the season, show who won each game,
	and show the total number of wins/losses for the season.
    </pre>
						</dd>

						<hr>
						<br>
						<dt>A Single Query</dt>
						<dd>
							<pre><code class="language-js"> var query = 'SELECT * FROM table_name;';
db.any(query)
    .then(function (rows) {
        res.render('pages/page_name',{
			my_title: "My Title Here",
			data: rows,
		})

    })
    .catch(function (err) {
        // display error message in case an error
        request.flash('error', err);
        res.render('pages/page_name',{
			my_title: "My Title Here",
			data: '',
		})
	})</code></pre>


						<a class="btn btn-warning dropdown-toggle" id="hidetext9" href="#explanation9" onclick="showExplanation(9)">More information</a>
						<br>
						<div id = "explanation9" style="display:none;">
								<dl class="row">
										<dt class="col-sm-3">var query</dt>
										<dd class="col-sm-9">The first step in accessing a postgres database, is to determine WHAT you want to access.  This query can be a select statement, an update, or even an insert statement.  These will be the main three query types you'll want to work with when accessing your database</dd>
										<dt class="col-sm-3">db.any(query)</dt>
										<dd class="col-sm-9">We use the database object we created at the top of server.js file make a call to the postgres database.  He we use the "any" method call which means we can have zero or more rows returned.  There are other options available (listed <a href="https://vitaly-t.github.io/pg-promise/Database.html">Here</a>). But for today's lab, when working with single queries we'll just use the "any" method.</dd>
										<dt class="col-sm-3">.then & .catch</dt>
										<dd class="col-sm-9">The then/catch components operate like a try/catch block in other programming languages.  Inside of the .then() we'll execute our code IF our query is successful (no errors), otherwise we will jump over to the .catch()</dd>
										<dt class="col-sm-3">function (rows) {</dt>
										<dd class="col-sm-9">Inside of our .then() we will create a function that will hold onto the results from our postgres query.  For this example, we have named the data "rows" but you can name it just about any variable name you wish.</dd>
										<dt class="col-sm-3">data: rows,</dt>
										<dd class="col-sm-9">Inside of the render call we will pass in our results as a parameter called data.  Which ever view we are rending will now be able to access our results via the parameter data.</dd>
									</dl>
						</div>

						</dd>
						<hr>
						<br>
						<dt>Multiple Queries</dt>
						<dd>
							<pre><code class="language-js">var query1 = 'select * from table_name;';
var query2 = 'select * from table_name_2;';
var query3 = 'select * from table_name_3;';
db.task('get-everything', task => {
    return task.batch([
        task.any(query1),
        task.any(query2),
        task.any(query3)
    ]);
})
.then(data => {
	res.render('pages/page_name',{
			my_title: "Page Title Here",
			result_1: data[0],
			result_2: data[1],
			result_3: data[2]
		})
})
.catch(error => {
    // display error message in case an error
        request.flash('error', err);
        res.render('pages/page_name',{
			my_title: "Page Title Here",
			result_1: '',
			result_2: '',
			result_3: ''
		})
});</code></pre>


							<a class="btn btn-warning dropdown-toggle" id="hidetext10" href="#explanation10" onclick="showExplanation(10)">More information</a>
							<br>
							<div id = "explanation10" style="display:none;">
									<dl class="row">
											<dt class="col-sm-5">db.task('get-everything', task => {</dt>
											<dd class="col-sm-7">We now have multiple queries to deal with!  To handle them all, we will use the database's task operation which can handle batch processing of our queries.</dd>
											<dt class="col-sm-5">task.any(query1),</dt>
											<dd class="col-sm-7">Inside of db.task() we can list as many queries as we need.  Just make sure to separate the queries with commas!</dd>
											<dt class="col-sm-5">result1: data[0],</dt>
											<dd class="col-sm-7">When working with multiple queries, we will have to operate with multiple results.  The variable info is an array with all of our results.  To access an individual query's results we use data[query_index]. </dd>
										</dl>
							</div>

						</dd>


					</dl>
				</div>
			</div>





		<div class="card card-body" id="step4">
			<div class="stepLine">
					<p class="alignleft h5">4. Football Player Page</p>
					<button class="btn btn-primary btn-sm alignbtn" type="button" onclick="updateProgressBar(4)" >Mark Complete</button>
					<button class="btn btn-primary btn-sm alignbtn" type="button" data-toggle="collapse" data-target="#multiCollapseExample4" aria-expanded="false" aria-controls="multiCollapseExample4">Expand</button>
					<p class="alignright h5">(<span class="time" id="time4">40</span> Minutes)</p>
				</div>
				<div class="collapse" id="multiCollapseExample4">
					<dl>
						<dt><br>TODO: Edit your server.js and player_info.pug files to populate the drop down selector and the player information table.</dt>
						<dd><br>
							<pre>
Football Player Page:
/player_info - get request (no parameters)
	This route will handle a single query to the football_players table which will retrieve the id & name for all of the football players.
	Next it will pass this result to the player_info view (pages/player_info), which will use the ids & names to populate the select tag for a form

/player_info/select_player - get request (player_id)
	This route will handle three queries and a work with a single parameter.
	Parameter:
		player_id - this will be a single number that refers to the football player's id.
	Queries:
		1. Retrieve the user id's & names of the football players (just like in /player_info)
		2. Retrieve the specific football player's informatioin from the football_players table
		3. Retrieve the total number of football games the player has played
							</pre>

						</dd>
					</dl>
				</div>
			</div>

			<div class="card card-body" id="step5">
				<div class="stepLine">
					<p class="alignleft h5">Submission Guidelines</p>
					<button class="btn btn-primary btn-sm alignbtn" type="button" data-toggle="collapse" data-target="#multiCollapseExample5" aria-expanded="false" aria-controls="multiCollapseExample5">Expand</button>
				</div>
				<div class="collapse" id="multiCollapseExample5">
					<ol><br>
						<dl>
							<dt><li>Create a new github repo and upload Lab_Website_3</li></dt>
							<dd>
								<ol>
									<li>On GitHub, create a new repository called Lab_Website_3. Make sure you don't overwrite any of the previous repos.</li>
									<li>Upload your Lab_Website_3 folder containing the entire directory structure for your website to GitHub. </li>
									<pre class="command-line" data-prompt="$"><code  class="language-bash">git init #MAKE SURE YOU ARE IN THE FOLDER Lab_Website_3 AND NOT IN ANY OTHER FOLDER BEFORE YOU RUN git init
git add .
git commit -m "Adding all of the files for lab 7"
git push</code></pre>
								</ol>

							</dd>
							<dt><li>Create a link to your GitHub repo</li></dt>
							<dd>
								In a text file (lab_7_link.txt), write down the following:
								<ol>
									<li>Your name</li>
									<li>You partner's name (if you have one)</li>
									<li>The link to your Lab_Website_3 Github Repo. (Make sure the repo is public!!!)</li>
								</ol>
							</dd>
							<dt><li>Submit to Canvas</li></dt>
							<dd>
								Submit your text file to Canvas.  Make sure all submissions have been uploaded by the Deadline.
							</dd>
						</dl>
					</ol>
				</div>
			</div>

		</main>
		<div id="bottom_nav">
			<div class="row">
				<div class="col-10">
				</div>
				<div class="col-2" >
				    <div class="row">
				        <div class="col-2">

				        </div>
				        <div class="col-10">
        					<button class="btn btn-primary btn-block alignright expandAll" type="button" >Expand All</button>
        					<button class="btn btn-primary btn-block alignright collapseAll" type="button" >Collapse All</button>
        				</div>
					</div>
				</div>
			</div>
		</div>

	</body>
</html>
